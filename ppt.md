name:inverse
class: center, middle,inverse
layout: true

---

# è·¨åŸŸ

Fighting
???

* ä¸ºä»€ä¹ˆè¦çŸ¥é“è·¨åŸŸ :ï¼‰å‘ç°å¾ˆå¤šåšå‰ç«¯å¼€å‘çš„ï¼Œå¯¹äºè‡ªå·±æ¯æ¯ç›¸å…³çš„è·¨åŸŸé—®é¢˜ï¼ˆåç«¯ä¸å…³å¿ƒã€APP ä¸å…³å¿ƒã€å®¢æˆ·ç«¯ä¹Ÿä¸å…³å¿ƒï¼‰ä¸€çŸ¥åŠè§£ï¼Œæœ‰äº›ç”šè‡³æ˜¯å…¨ç„¶ä¸çŸ¥ã€‚
* ä¸ºä»€ä¹ˆè¦çŸ¥é“å¦‚ä½•è·¨åŸŸ ä¸è¦æŠŠè‡ªå·±æ¡†æ­»åœ¨å‰ç«¯ã€‚ç¼“å­˜ã€http åè®®ã€ä¸šåŠ¡é€»è¾‘ã€åç«¯å¼€å‘ã€æ•°æ®åº“ã€æœåŠ¡å™¨é…ç½®ç­‰ç­‰ï¼Œéƒ½è¦ç†Ÿæ‚‰ã€‚

æœ¬æ¬¡åˆ†äº«æ—¨åœ¨ç”±æµ…å…¥æ·±ï¼Œè®©ä¹‹å‰ä¸æ‡‚è·¨åŸŸçš„å°ä¼™ä¼´çŸ¥é“è·¨åŸŸæ˜¯æ€ä¹ˆå›äº‹ï¼Œè®©å·²ç»çŸ¥é“è·¨åŸŸæ¦‚å¿µçš„å°ä¼™ä¼´ï¼ŒçŸ¥é“å¦‚ä½•è‡ªå·±é…ç½®è·¨åŸŸï¼Œå†ç„¶åä¸æ·±è°™è·¨åŸŸä¹‹é“çš„å°ä¼™ä¼´æ¢è®¨ä¸€ä¸‹ä¸€äº›æˆ‘çš„æ€è€ƒã€‚

å½“æˆ‘ä»¬åœ¨èŠè·¨åŸŸçš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨èŠä»€ä¹ˆï¼Ÿ

* æŠ¥é”™ [demo1](/demo/1.html)
* JSONP (å¤šå°‘äººçŸ¥é“åŸç†)
* CORS(Cross-Origin Resource Sharing)

---

* ###åŒæºç­–ç•¥

--

* ###é™åˆ¶åŸå› 

--

* ###HTTP åè®®

--

* ###å¦‚ä½•è·¨åŸŸ

--

* ###è·¨åŸŸå®‰å…¨

???

ä¸ºä»€ä¹ˆè¦ä»è¿™äº›æ–¹é¢èŠè·¨åŸŸé—®é¢˜

å­¦ä¹ ä»»ä½•æŠ€æœ¯éƒ½åº”è¯¥ä»¥å¦‚æ­¤å¿ƒæ€åŠè§„åˆ’

åœ¨çŸ¥è¯†å¹¿åº¦å¤Ÿçš„æƒ…å†µä¸‹ï¼ŒåŠ æ·±æ·±åº¦ã€‚ä¸ç„¶è¯´èµ·è·¨åŸŸï¼ŒåªçŸ¥é“ jsonp

ä»¥ promise ä¸ºä¾‹è®²è§£å¦‚ä½•æ‹“å®½çŸ¥è¯†æ·±åº¦ï¼›
promise ä¸æ˜¯ä»…ä»…é‚£å‡ ä¸ª apiï¼›
promise è¯‘ä½œæ‰¿è¯º è§£å†³ä¿¡ä»»é—®é¢˜ï¼Œæœªæ¥å¼‚æ­¥ç¼–ç¨‹çš„åŸºçŸ³ï¼›
callback å¯è°ƒã€å¯ä¸è°ƒã€è°ƒå‡ æ¬¡ã€å¼‚æ­¥è°ƒã€åŒæ­¥è°ƒï¼›

---

# åŒæºç­–ç•¥

---

.left-column[

## åŒæº

]
.right-column[
.left[

> å¦‚æœä¸¤ä¸ªé¡µé¢çš„åè®®ã€åŸŸåã€ç«¯å£éƒ½ç›¸åŒï¼Œåˆ™ä¸¤ä¸ªé¡µé¢å…·æœ‰ç›¸åŒçš„æºã€‚

]
]

---

.left-column[

## åŒæº

## ç­–ç•¥

]
.right-column[
.left[

> åŒæºç­–ç•¥é™åˆ¶äº†ä»åŒä¸€ä¸ªæºåŠ è½½çš„æ–‡æ¡£æˆ–è„šæœ¬å¦‚ä½•ä¸æ¥è‡ªå¦ä¸€ä¸ªæºçš„èµ„æºè¿›è¡Œäº¤äº’ã€‚

* æ•°æ®è®¿é—®
* ç½‘ç»œè®¿é—®

]]

???

è¡¨ç°åœ¨ï¼š

æœ¬åœ°æ•°æ®è®¿é—®æ§åˆ¶ï¼š

* cookie
* storage
* indexDB
* DOM

ç½‘ç»œè®¿é—®æ§åˆ¶

* web å­—ä½“
* canvas åŠ è½½å›¾ç‰‡
* webGL

ï¼ˆJSONP ç®—æ˜¯ä¸€ç§å–å·§ï¼‰
imgã€scriptã€linkã€videoã€objectã€iframe

* [ç½‘ç»œè®¿é—® demo](/demo/1.html)
* [Dom è®¿é—® demo](/demo/2.html)
* [èµ„æºè®¿é—® demo](/demo/3.html)

---

.left-column[

## åŒæº

## ç­–ç•¥

## ğŸŒ°

]
.right-column[
.left.right-img[

URL:http://www.example.com/dir/page.html

![åŒæºç­–ç•¥](./images/same-origin-policy.png)

]
]

---

# é™åˆ¶åŸå› 

???

é›†æ€å¹¿ç›Šå‚ä¸è®¨è®º

å®‰å…¨ï¼Ÿæ€ä¹ˆä¸å®‰å…¨ï¼Ÿ

---

.left-column[

## å‡å¦‚

]
.right-column[
.left.right-img[

![å‡å¦‚å…è®¸è·¨åŸŸ](./images/cross-dmain.png)

]
]

---

.left-column[

## å‡å¦‚

## ç–‘æƒ‘

]
.right-column[
.left[

* ä»¥ä¸Šçš„æ”»å‡»åŸºäº cookie ï¼ˆæœ¬åœ°æ•°æ®ï¼‰çš„è·¨åŸŸå…±äº«ï¼Œæ—¢ç„¶æ˜¯ cookie çš„ä¸å®‰å…¨å¯¼è‡´äº†è·¨åŸŸçš„ä¸å®‰å…¨ï¼Œä»…ä»…ç¦æ­¢è·¨åŸŸå…±äº« cookie å°±å¥½äº†ï¼Œä¸ºä½•è¦é™åˆ¶è·¨åŸŸç½‘ç»œçš„è®¿é—®ï¼Ÿ
* è·¨åŸŸé™åˆ¶å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œè·¨åŸŸè¯·æ±‚æ˜¯å¦çœŸçš„æ— æ³•å‘é€ï¼Ÿ

]
]

???

* ### ip é‰´æƒåœºæ™¯ï¼Œå†…ç½‘ç³»ç»Ÿï¼Œæœ‰ä¸€ä¸ªç”µè„‘å¯ä»¥ä¸Šç½‘ï¼Œå°±èƒ½æ‹¿åˆ°æ‰€æœ‰çš„å†…ç½‘èµ„æº
* ### å…è´¹çš„åˆ†å¸ƒå¼çˆ¬è™«

### è·¨åŸŸè¯·æ±‚æ˜¯å¦çœŸçš„æ— æ³•å‘é€ï¼Ÿ æ˜¯ï¼Œä¹Ÿä¸æ˜¯

* èµ„æºåŠ è½½ img,css,script,video...
* form è¡¨å•æäº¤ [form è·¨åŸŸæäº¤](/demo/5.html)
* æ™®é€š ajax è¯·æ±‚ [è·¨åŸŸæ˜¯å¦ä¼šå‘é€è¯·æ±‚æˆåŠŸ demo](/demo/7.html)

æŠ“åŒ…æ¼”ç¤º

https å‘ http çš„è¯·æ±‚ä¼šè¢«æµè§ˆå™¨æ‹¦æˆª(å…¶å®ä¹Ÿæ˜¯ csp ç­–ç•¥ï¼Œåªæ˜¯æµè§ˆå™¨é»˜è®¤å¯ç”¨äº†)

csp ç­–ç•¥é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œè¯·æ±‚ä¸ä¼šå‘é€

~~~ éç®€å•è¯·æ±‚ï¼Œåœ¨ option è¯·æ±‚é€šè¿‡ä¹‹å‰ï¼Œä¸ä¼šåˆ°è¾¾åç«¯æœåŠ¡ ~~~

---

# HTTP åè®®

???

* [RFC 2616 (http/1.1)](https://tools.ietf.org/html/rfc2616)
* [RFC 7540 (http/2)](https://tools.ietf.org/html/rfc7540)
* [HTTP æƒå¨æŒ‡å—](https://item.jd.com/11056556.html)
* [http2 Demo](https://http2.akamai.com/demo)

- å½¢æ€
- è¿æ¥
- ç½‘å…³
- è®¤è¯
- ä»£ç†
- ç¼“å­˜
- å®‰å…¨
- ç¼–ç 

ä¸åšç»†è‡´è®²è§£

---

.left-column[

## åè®®

]
.right-column[
.left.right-img[
![ç™½äº‘é»‘åœŸ](./images/baiyunheitu.jpg)
]
]

???

å–æ°´ã€é—­å˜´ã€æ‰è…¿ã€äº²ä¸€å£ï¼Œè€é¬¼

[è§†é¢‘é“¾æ¥ 8:15 ç§’å¤„](http://tv.cntv.cn/video/C38143/35c0812421a33ddd958986650a4e5c44)

---

.left-column[

## åè®®

## è¯·æ±‚

]
.right-column[
.left[

```
GET /v1/getUserInfo HTTP/1.1
Host: fighting.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.170 Safari/537.36
Accept: text/html,application/xhtml+xml,application/json;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Connection: keep-alive
Referer: http://fighting.com/examples/access-control/simpleXSInvocation.html
Origin: http://fighting.com
```

]
]

---

.left-column[

## åè®®

## è¯·æ±‚

## å“åº”

]
.right-column[
.left[

```
HTTP/1.1 200 OK
Date: Mon, 01 Dec 2008 00:23:53 GMT
Server: Apache/2.0.61
Access-Control-Allow-Origin: *
Keep-Alive: timeout=2, max=100
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: application/json

{"msg":"success","code":10}
```

]
]

---

# å¦‚ä½•è·¨åŸŸ

--

### CORS(Cross-Origin Resource Sharing)

???

[cors å…¼å®¹æ€§](https://caniuse.com/#search=cors)

è¢«æ»¥ç”¨çš„ jsonp
è¢«æ»¥ç”¨çš„ cookie

* JSONPï¼ˆæ— æ³• postï¼‰
* location.hash
* document.domain(ä¸»åŸŸç›¸åŒ)
* document.name
* navigator è·¨åŸŸ ï¼ˆIE6ã€7ï¼‰
* message æœºåˆ¶ (HTML5)
* flash
* ...

è·¨åŸŸåªæ˜¯é’ˆå¯¹æµè§ˆå™¨çš„ç­–ç•¥ï¼Œå› ä¸ºæµè§ˆå™¨æ˜¯å…¬å…±ç¯å¢ƒã€‚

---

.left-column[

## è¯·æ±‚å¤´

]
.right-column[
.left[

* Access-Control-Request-Headers
* Access-Control-Request-Method

  ]]

???

è¿™ä¸¤ä¸ªè¯·æ±‚å¤´åªå‡ºç°åœ¨é¢„æ£€è¯·æ±‚ä¸­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸ç¢°åˆ°çš„ options è¯·æ±‚

æµè§ˆå™¨è‡ªå‘è¡Œä¸º

---

.left-column[

## è¯·æ±‚å¤´

## å“åº”å¤´

]
.right-column[
.left[

* Access-Control-Allow-Headers
* Access-Control-Request-Method
* Access-Control-Allow-Origin
* Access-Control-Expose-Headers
* Access-Control-Max-Age
* Access-Control-Allow-Credentials

]]

???

* é™¤äº† Access-Control-Allow-Originï¼Œå…¶å®ƒçš„å“åº”å¤´å‡æœªå®ç°\*å·
* Access-Control-Allow-Headers ä¸­ä»¥ä¸‹æ˜¯é»˜è®¤æ”¯æŒçš„ï¼Œä¸éœ€è¦åˆ—å‡ºæ¥ï¼šAcceptã€Accept-Languageã€Content-Languageã€Content-Typeã€‚ä½† Content-Type åªèƒ½æ˜¯ application/x-www-form-urlencodedã€multipart/form-data æˆ– text/plain
* Access-Control-Allow-Credentials true/false åŒºåˆ†å¤§å°å†™
* Access-Control-Max-Age å•ä½ä¸ºç§’
* Access-Control-Expose-Headers é»˜è®¤åªèƒ½è®¿é—® Cache-Controlã€Content-Languageã€Content-Typeã€Expiresã€Last-Modifiedã€Pragma

---

# é¢„æ£€è¯·æ±‚

--

### preflight

---

.left-column[

## æè¿°

]
.right-column[
.left[

> è·¨åŸŸèµ„æºå…±äº«æ ‡å‡†æ–°å¢äº†ä¸€ç»„ HTTP é¦–éƒ¨å­—æ®µï¼Œå…è®¸æœåŠ¡å™¨å£°æ˜å“ªäº›æºç«™æœ‰æƒé™è®¿é—®å“ªäº›èµ„æºã€‚å¦å¤–ï¼Œè§„èŒƒè¦æ±‚ï¼Œå¯¹é‚£äº›å¯èƒ½å¯¹æœåŠ¡å™¨æ•°æ®äº§ç”Ÿå‰¯ä½œç”¨çš„ HTTP è¯·æ±‚æ–¹æ³•ï¼ˆç‰¹åˆ«æ˜¯ GET ä»¥å¤–çš„ HTTP è¯·æ±‚ï¼Œæˆ–è€…æ­é…æŸäº› MIME ç±»å‹çš„ POST è¯·æ±‚ï¼‰ï¼ˆéç®€å•è¯·æ±‚ï¼‰ï¼Œæµè§ˆå™¨å¿…é¡»é¦–å…ˆä½¿ç”¨ OPTIONS æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚ï¼ˆpreflight requestï¼‰ï¼Œä»è€Œè·çŸ¥æœåŠ¡ç«¯æ˜¯å¦å…è®¸è¯¥è·¨åŸŸè¯·æ±‚ã€‚æœåŠ¡å™¨ç¡®è®¤å…è®¸ä¹‹åï¼Œæ‰å‘èµ·å®é™…çš„ HTTP è¯·æ±‚ã€‚åœ¨é¢„æ£€è¯·æ±‚çš„è¿”å›ä¸­ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿå¯ä»¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ˜¯å¦éœ€è¦æºå¸¦èº«ä»½å‡­è¯ï¼ˆåŒ…æ‹¬ Cookies å’Œ HTTP è®¤è¯ç›¸å…³æ•°æ®ï¼‰ã€‚

]]

---

.left-column[

## æè¿°

## Simple Requests

]
.right-column[
.left[
æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š

* è¯·æ±‚æ–¹æ³•ï¼šGETã€HEADã€POST
* è‡ªå®šä¹‰å¤´ï¼šAcceptã€Accept-Languageã€Content-Languageã€Content-Type
* Content-Type ä»…é™å€¼ï¼štext/plainã€multipart/form-dataã€application/x-www-form-urlencoded
* è¯·æ±‚ä¸­çš„ä»»æ„ XMLHttpRequestUpload å¯¹è±¡å‡æ²¡æœ‰æ³¨å†Œä»»ä½•äº‹ä»¶ç›‘å¬å™¨
* è¯·æ±‚ä¸­æ²¡æœ‰ä½¿ç”¨ ReadableStream å¯¹è±¡ã€‚

]]

???

* ReadableStream åªæœ‰ chrome å®ç°äº†
* XMLHttpRequestUpload å¯¹è±¡å¯ä»¥ä½¿ç”¨ XMLHttpRequest.upload å±æ€§è®¿é—®ã€‚

---

.left-column[

## æè¿°

## Simple Requests

## Preflight

]
.right-column[
.left[

    ![prelight](./images/prelight.png)

]]

???

[è§¦å‘ option è¯·æ±‚ demo](/demo/7.html)

é¢„æ£€è¯·æ±‚è¢«é‡å®šå‘ä¼šå‡ºé”™

é¢„æ£€è¯·æ±‚éœ€è¦è¿”å› 200 æˆ– 204ï¼Œæ›´æ¨è 204 No Content, douban è¿™é‡Œç›´æ¥è®©é¢„æ£€è¿›å…¥äº†åç«¯æœåŠ¡

[è·¨åŸŸ ajax ä¸æŠ¥é”™ demo](/demo/9.html)

æˆ‘ä»¬ä½¿ç”¨ Service workers ç¼“å­˜ cdn ä¸Šçš„é™æ€èµ„æºï¼Œä½†æ˜¯è·¨åŸŸæŠ¥é”™ã€‚
fetch mode https://developer.mozilla.org/zh-CN/docs/Web/API/Request/mode

Cache ç›¸å…³ API https://developer.mozilla.org/zh-CN/docs/Web/API/Cache

SErvice workers https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API

SErvice workers æœªæ¥å¾ˆæœ‰æƒ³è±¡ç©ºé—´çš„ä¸œè¥¿

---

#è·¨åŸŸå®‰å…¨

???

åŒæºç­–ç•¥çš„åˆè¡·æ˜¯ä¸ºäº†å®‰å…¨ï¼Œä½†ç‰ºç‰²äº†å¾ˆå¤šä¾¿æ·æ€§ï¼Œç„¶åæœ‰äº†è·¨åŸŸï¼Œè·¨åŸŸæ’•å¼€äº†ä¸€é“å£å­ï¼Œå¦‚ä½•ä¿è¯å®‰å…¨ï¼Ÿå®‰å…¨æ˜¯å¤´ç­‰å¤§äº‹ï¼Œå¦‚æœæ»¥ç”¨è·¨åŸŸå¯¼è‡´å®‰å…¨é—®é¢˜ï¼Œé‚£å°±å¾—ä¸å¿å¤±äº†ã€‚

* Access-Control-Allow-Originï¼š\* ä¸ä¹‹å‰è®¨è®ºçš„æµè§ˆå™¨é»˜è®¤å…è®¸è·¨åŸŸï¼Œä½†ä¸æºå¸¦ cookie ä¸€æ ·
* Access-Control-Allow-Credentials:true å…è®¸æºå¸¦ cookie çš„æƒ…å†µä¸‹ï¼Œä¸Šé¢é€‰é¡¹ä¸èƒ½è®¾ç½®ä¸º\* ä¸ºä»€ä¹ˆï¼Ÿ ï¼ˆï¼šä¸ºå®‰å…¨æ“ç¢äº†å¿ƒçš„å§”å‘˜ä¼š [ä¸å®‰å…¨é…ç½®å‡ºé”™ demo](/demo/8.html)
* form è¡¨å•è·¨åŸŸæäº¤å®‰å…¨é—®é¢˜
* [CSP ç­–ç•¥](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy__by_cnvoid)
* JSONP çš„æ»¥ç”¨ï¼Œå±é™©ç‚¹åœ¨å“ªï¼Œå¦‚ä½•é˜²ï¼Œæ˜¯å¦ script æ ‡ç­¾ä¸€å®šä¼šå‘é€ cookieï¼Ÿ å…ˆçœ‹å®ä¾‹--> [JSON å®‰å…¨é—®é¢˜ Demo](/demo/6.html) ï¼ˆcrossorigin="anonymous"ï¼Œä¼ é€’é”™è¯¯çš„å€¼ä¹Ÿä¸ä¼šå‘é€ cookieï¼‰

JSONP é˜²å¾¡å¯ä» referer æ¥å±•å¼€è®²ï¼Œä»¥[ä»€ä¹ˆå€¼å¾—ä¹°](https://www.smzdm.com)çš„ä¸ªäººä¿¡æ¯æ¥å£å±•å¼€æ¥è®²

CSP ç­–ç•¥å¯ä»¥åˆ° twitter æ¼”ç¤º

ç™¾åº¦æœ CSP é˜®ä¸€å³°

* referer åŒ¹é…åŸŸå
* referer æœªè€ƒè™‘ç©º ,äººé€ ç©º referer [demo4](/demo/4.html), [Referrer-Policy](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Referrer-Policy)
* Content-Type: application/json; charset=utf-8 +/v8 è§¦å‘ utf7-BOM
  ![jsonp](./images/dns.png)

---

.right-column[
.left[

```
    const review = [
        'ä½•ä¸ºåŒæºç­–ç•¥',
        'ä¸ºä½•é™åˆ¶è·¨åŸŸ',
        'HTTPåè®®',
        'CORS',
        'å®‰å…¨'
    ]
```

]]

---

```
    console.log("Thanks!");
```

```

```
